"use strict";function DiceRoller(a){function b(){var a,b=_.random(1,20);return a=b>=c.criticalThreshold?"criticalSuccess":1===b?"criticalFailure":b+c.bonus>c.difficulty?"success":"failure",{roll:b+c.bonus,result:a}}var c=_.extend({criticalThreshold:20,bonus:0,difficulty:50},a);return b}function Fighter(a){var b,c=a,d=null,e={bonus:c.stats.hitBonus,criticalThreshold:c.weapon.critical[0]};return{stats:c.stats,weapon:c.weapon,attribute:c.attribute,get target(){return d},set target(a){d=a,e.difficulty=a.stats.defence,b=new DiceRoller(e)},attack:function(){return b()},rollDamages:function(){for(var a=c.weapon.damages.slice(0,c.weapon.damages.indexOf("d")),b=c.weapon.damages.slice(c.weapon.damages.indexOf("d")+1,c.weapon.damages.length),d=0,e=0;a>e;e++)d+=_.random(1,b);return d},takeDamages:function(a){c.stats.life-=a}}}angular.module("rpgApp",["ngCookies","ngRoute","ngSanitize"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",controllerAs:"main"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl",controllerAs:"about"}).when("/faq",{templateUrl:"views/faq.html",controller:"FaqCtrl",controllerAs:"faq"}).otherwise({redirectTo:"/"})}]),angular.module("rpgApp").service("MapServ",function(){var a={};return{load:function(){return $.getJSON("resources/map.json",function(b){a.map=b.map})},reflect:function(){var b=1===_.random(1),c=1===_.random(1);if(b)for(var d=0;d<a.map.length;d++)a.map[d]=a.map[d].reverse();c&&(a.map=a.map.reverse())},isWall:function(b){return b[0]>=a.map[0].length||b[1]>=a.map.length?!0:0===a.map[b[1]][b[0]]},getMap:function(){return a.map}}}),angular.module("rpgApp").service("CharServ",["MapServ",function(a){function b(){var b,c;do b=_.random(0,37),c=_.random(0,35);while(a.isWall([b,c]));return[b,c]}function c(){var a=_.random(0,2),b=_.random(0,2),c=a+b;return c}function d(){if(f.stats.experience-=1e3*f.stats.level,f.stats.level+=1,f.stats.level%5===0){var a=_.shuffle([1,0,0]),b=0;_.forIn(f.attribute,function(c,d){f.attribute[d]=c+a[b],b+=1})}e(),f.stats.life=f.stats.lifeMax}function e(){f.stats.lifeMax=f.stats.level*(8+f.attribute.endurance),f.stats.hitBonus=_.floor((f.stats.level+f.attribute.strength+f.weapon.hitBonus+f.weapon.enhancement)*(1-f.armor.weight/100)),f.stats.defence=10+f.attribute.dexterity+f.armor.defence+f.armor.enhancement}var f={};return{create:function(){var a=b();f.position={x:a[0],y:a[1]},f.attribute={strength:c(),dexterity:c(),endurance:c()},f.stats={name:"Carlisle",level:1,experience:0},f.weapon={name:"Rusty Sword",damages:"1d6",hitBonus:1,critical:[19,2],enhancement:0},f.armor={name:"Worn Leather Armor",weight:10,defence:1,enhancement:0},e(),f.stats.life=f.stats.lifeMax,f.spells={"Heavy Blow":{damages:5,hitBonus:-2,mana:1},"Precise Blow":{damages:-1,hitBonus:2,mana:1}},f.inventory=[{name:"Resurection Stone",quantity:3,usable:!1}]},getPosition:function(){return[f.position.x,f.position.y]},updatePosition:function(a){f.position.x+=a[0],f.position.y+=a[1]},getAllDatas:function(){return{stats:_.extend({},f.stats),attribute:f.attribute,weapon:f.weapon,armor:f.armor,spells:f.spells,inventory:f.inventory}},takeDamages:function(a){f.stats.life-=a,f.stats.life<1&&this.die()},getXP:function(a){var b=["You got "+a+" XP!"];return f.stats.experience+=a,f.stats.experience>=1e3*f.stats.level&&(d(),b.push("You gained a level! You are now level "+f.stats.level)),b},gainItem:function(a){var b=!1;_.forIn(f.inventory,function(c){c.name===a.name&&(c.quantity+=1,b=!0)}),b||(a.quantity=1,f.inventory.push(a))},useItem:function(a){_.forIn(f.inventory,function(b){b.name===a&&(b.quantity-=1)})},gainWeapon:function(a){f.weapon=a,e()},gainArmor:function(a){f.armor=a,e()},die:function(){if(f.inventory[0].quantity>0)return f.inventory[0].quantity-=1,f.stats.life=f.stats.lifeMax,["The use of a Resurection Stone allows you to continue your adventure ("+f.inventory[0].quantity+" left)."];var a=f.position;return this.create(),f.position=a,["No Resurection Stones left - Game Over.","New Game started"]},manaRegen:function(a){var b=a||1;f.stats.mana=Math.min(f.stats.mana+b,f.stats.manaMax)},lifeRegen:function(a){var b=a||1;f.stats.life=Math.min(f.stats.life+b,f.stats.lifeMax)}}}]),angular.module("rpgApp").service("ItemsDB",["CharServ",function(a){function b(a){return 2*a-21}function c(a){return a+1}function d(a){return a+2}function e(a){return a-2}function f(a){var b=2*parseInt(a.slice(0,1),10);return b+a.slice(1)}function g(a){var b=parseInt(a.slice(a.indexOf("d")+1),10)-2;return a.slice(0,a.indexOf("d")+1)+b}function h(a){return a+1}function i(a){return _.floor(.85*a)}function j(a){return a+10}function k(a){return _.max([a-10,0])}var l=[{name:"dagger",damages:"1d4",hitBonus:5,critical:[19,2]},{name:"Rapier",damages:"1d6",hitBonus:3,critical:[18,2]},{name:"Sword",damages:"1d8",hitBonus:1,critical:[19,2]},{name:"Bastard Sword",damages:"1d10",hitBonus:1,critical:[19,2]},{name:"Two-handed Sword",damages:"2d6",hitBonus:-1,critical:[19,2]},{name:"Mace",damages:"1d6",hitBonus:0,critical:[20,2]},{name:"Warhammer",damages:"1d8",hitBonus:1,critical:[20,3]},{name:"Heavy Flail",damages:"1d10",hitBonus:0,critical:[19,2]},{name:"Hand Axe",damages:"1d6",hitBonus:2,critical:[20,3]},{name:"Battle Axe",damages:"1d8",hitBonus:1,critical:[20,3]},{name:"Halleberd",damages:"1d10",hitBonus:0,critical:[20,3]},{name:"Great Axe",damages:"1d12",hitBonus:-1,critical:[20,3]},{name:"Scythe",damages:"2d4",hitBonus:-2,critical:[20,4]}],m=[{name:"Padded Armor",weight:5,defence:1},{name:"Leather Armor",weight:10,defence:2},{name:"Hide Armor",weight:15,defence:3},{name:"Scale Mail",weight:20,defence:4},{name:"Chain Mail",weight:25,defence:5},{name:"Splint Mail",weight:30,defence:6},{name:"Half Plate",weight:35,defence:7},{name:"Full Plate",weight:40,defence:8}],n=[{name:"Minor Life Potion",description:"Regain 10 Life Points",usable:!0,use:function(){a.lifeRegen(10)}},{name:"Medium Life Potion",description:"Regain 50 Life Points",usable:!0,use:function(){a.lifeRegen(50)}},{name:"Major Life Potion",description:"Regain 100 Life Points",usable:!0,use:function(){a.lifeRegen(100)}}],o=[{name:"Resurection Stone",usable:!1}];return{randomBaseWeapon:function(a){var b=_.merge({},l[_.random(l.length-1)]);return b.enhancement=_.max([a+1,0]),b.enhancement>0&&(b.name+=" + "+b.enhancement),b},randomBaseArmor:function(a){var b=_.merge({},m[_.random(m.length-1)]);return b.enhancement=_.max([a+1,0]),b.enhancement>0&&(b.name+=" + "+b.enhancement),b},randomWeapon:function(){var h=_.merge({},l[_.random(l.length-1)]),i=_.random(10),j=_.random(10),k=_.random(10);3>j&&(h.damages=g(h.damages),h.name="Rusty "+h.name),j>8&&(h.critical[0]=b(h.critical[0]),h.name="Sharp "+h.name),3>i&&(h.hitBonus=e(h.hitBonus),h.name="Unbalanced "+h.name),i>8&&(h.hitBonus=d(h.hitBonus),h.name="Well-balanced "+h.name),2>k&&(h.damages=f(h.damages),h.name+=" of Brutality"),k>8&&(h.critical[1]=c(h.critical[1]),h.name+=" of Extermination");var m=a.getAllDatas().stats.level;return h.enhancement=_.floor(_.random(0,m)/3)+_.floor(m/5),h.enhancement>0&&(h.name+=" + "+h.enhancement),h},randomArmor:function(){var b=_.merge({},m[_.random(m.length-1)]),c=_.random(10),d=_.random(10),e=_.random(10);3>d&&(b.weight=j(b.weight),b.name="Heavy "+b.name),d>8&&(b.weight=k(b.weight),b.name="Light "+b.name),3>c&&(b.defence=i(b.defence),b.name="Worn "+b.name),c>8&&(b.defence=h(b.defence),b.name="Wellcrafted "+b.name),2>e&&(b.weight=_.max([b.weight-15,0]),b.name+=" of Swiftness"),e>8&&(b.defence+=3,b.name+=" of Protection");var f=a.getAllDatas().stats.level;return b.enhancement=_.floor(_.random(0,f)/3)+_.floor(f/5),b.enhancement>0&&(b.name+=" + "+b.enhancement),b},randomPotion:function(){var a=_.merge({},n[_.random(n.length-1)]);return a},randomRare:function(){var a=_.merge({},o[_.random(o.length-1)]);return a}}}]),angular.module("rpgApp").service("GameDraw",function(){function a(a,b){var c=new PIXI.Sprite(b);c.scale.set(.125),c.position.x=a[0],c.position.y=a[1],e.map.addChild(c)}function b(b){e.map=new PIXI.Container,e.dungeon.addChild(e.map);for(var c=[0,0],d=0;d<b.length;d++){c[0]=0;for(var f=0;f<b[d].length;f++)0===b[d][f]?a(c,e.texture.wall):a(c,e.texture.ground),c[0]+=32;c[1]+=32}}function c(a){e.character=new PIXI.Sprite(e.texture["char"]),e.character.anchor.set(.5),e.character.scale.set(.5),e.character.position.x=32*a[0]+16,e.character.position.y=32*a[1]+16,e.dungeon.addChild(e.character)}function d(){e.boss=new PIXI.Sprite(e.texture.boss),e.boss.anchor.set(.5),e.boss.scale.set(.75),e.boss.position.x=592,e.boss.position.y=560,e.dungeon.addChild(e.boss)}var e={};return{getGame:function(){return e.dungeon},getCharPosition:function(){return[e.character.position.x,e.character.position.y]},init:function(a,f){return e.dungeon=new PIXI.Container,e.dungeon.position.x=160,e.texture={ground:PIXI.Texture.fromImage("images/ground.6ceb1461.png"),wall:PIXI.Texture.fromImage("images/wall.e3f6fad4.png"),"char":PIXI.Texture.fromImage("images/map_player.a6466ded.png"),boss:PIXI.Texture.fromImage("images/castle.8f80c5ff.png")},b(a),d(),c(f),e.dungeon},moveChar:function(a){var b=function(){e.character.position.x+=a[0],e.character.position.y+=a[1]},c=5,d=32;return[b,c,d]},moveMap:function(a){var b=function(){e.dungeon.position.x+=a[0],e.dungeon.position.y+=a[1]},c=20,d=32;return[b,c,d]}}}),angular.module("rpgApp").service("InterfaceDraw",["CharServ",function(a){function b(){n.leftPanelBackground=new PIXI.Sprite(n.texture.leftPanelBackground),n.leftPanel.addChild(n.leftPanelBackground);var a=[{name:"Character",open:e},{name:"Items",open:i},{name:"Inventory",open:f},{name:"Spells",open:h},{name:"Help",open:j}];n.menuItems=[];for(var b=0;b<a.length;b++)n.menuItems.push(c(a[b])),n.menuItems[b].position.y=10+55*b,n.leftPanel.addChild(n.menuItems[b]);n.overlayWindow=new PIXI.Container,n.overlayWindow.position.x=160,n.overlayWindow.renderable=!1,n["interface"].addChild(n.overlayWindow),n.overlayBackground=new PIXI.Sprite(n.texture.overlayBackground),n.overlayWindow.addChild(n.overlayBackground)}function c(a){var b=new PIXI.Container,c=new PIXI.Sprite(n.texture.button);c.scale.set(.7),c.position.x=10,b.buttonMode=!0,b.interactive=!0,b.on("mouseover",function(){c.texture=n.texture.buttonHover}).on("mouseout",function(){c.texture=n.texture.button}).on("click",function(){(_.isUndefined(n.menuTitle)||n.menuTitle._text!==n.fightTitle)&&(n.overlayWindow.renderable&&n.menuTitle._text===a.name?(n.overlayWindow.renderable=!1,d()):(n.overlayWindow.renderable=!0,d(),a.open()))});var e=new PIXI.Text(a.name);return e.x=20,e.y=10,b.addChild(c),b.addChild(e),b}function d(){n.overlayWindow.removeChildren(),n.menuTitle=void 0,n.overlayBackground=new PIXI.Sprite(n.texture.overlayBackground),n.overlayWindow.addChild(n.overlayBackground)}function e(){n.menuTitle=l("Character",[20,10]);var b=a.getAllDatas(),c={};l(b.stats.name,[50,80],c);var d=new PIXI.Sprite(n.texture["char"]);d.position.x=0,d.position.y=150,d.scale.set(2),n.overlayWindow.addChild(d),l("Level  "+b.stats.level+"  ("+b.stats.experience+" / "+1e3*b.stats.level+")",[350,100],c),l("Life   "+b.stats.life+" / "+b.stats.lifeMax,[350,150],c),l("Bonus to hit: "+b.stats.hitBonus,[350,235],c),l("Defence:      "+b.stats.defence,[350,270],c);var e=350,f=320,g=30;l("Attributes",[e,f],c),_.forIn(b.attribute,function(a,b){l(b+": "+a,[e+10,f+g],c),g+=30})}function f(){n.menuTitle=l("Inventory",[20,10]);var b=a.getAllDatas(),c=30;_.forIn(b.inventory,function(a){a.quantity>0&&(g(a,c),c+=30)})}function g(b,c){var e={},g=new PIXI.Container,h=new PIXI.Sprite(n.texture.empty);g.addChild(h),g.position.x=45,g.position.y=50+c,g.buttonMode=!0,g.interactive=!0;var i;b.usable?(i=l(b.description,[350,50+c],{}),g.on("click",function(){b.use(),a.useItem(b.name),d(),f()})):i=l("Not usable",[350,50+c],{}),i.renderable=!1,g.on("mouseover",function(){i.renderable=!0}).on("mouseout",function(){i.renderable=!1}),l("- "+b.quantity+" "+b.name,[40,50+c],e),n.overlayWindow.addChild(g)}function h(){n.menuTitle=l("Spells",[20,10]),l("Not yet implemented",[50,80],{})}function i(){n.menuTitle=l("Items",[20,10]);var b=a.getAllDatas(),c={font:"bold italic 26px Arial",fill:"#F7EDCA",stroke:"#4a1850",strokeThickness:5};l(b.weapon.name,[50,80],c),l("[image]",[80,180]),0===b.weapon.enhancement?l("damages: "+b.weapon.damages,[330,150],{}):l("damages: "+b.weapon.damages+" + "+b.weapon.enhancement,[330,150],{});var d=b.weapon.hitBonus+b.weapon.enhancement;l("hit bonus: "+d,[330,180],{}),l("crit: "+b.weapon.critical[0]+"-20  x"+b.weapon.critical[1],[330,210],{}),l(b.armor.name,[50,340],c),l("[image]",[80,410]);var e=b.armor.defence+b.armor.enhancement;l("armor: "+e,[330,410],{}),l("weight: "+b.armor.weight,[330,440],{})}function j(){n.menuTitle=l("Help",[20,10]),l("Sorry you can't count on anyone's help for now",[50,80],{font:"bold 20px Arial"})}function k(){n.menuTitle=l(n.fightTitle,[10,10]),n.playerSprite=new PIXI.Sprite(n.texture["char"]),n.playerSprite.scale.set(1.5),n.playerSprite.position.x=40,n.playerSprite.position.y=70,n.overlayWindow.addChild(n.playerSprite),n.playerLife=l("life "+n.player.stats.life+" / "+n.player.stats.lifeMax,[80,250],n.style.playerLife),"Imperator A."===n.mob.stats.name?n.mobSprite=new PIXI.Sprite(n.texture.boss):n.mobSprite=new PIXI.Sprite(n.texture.monster),n.mobSprite.scale.set(1.5),n.mobSprite.position.x=340,n.mobSprite.position.y=70,n.overlayWindow.addChild(n.mobSprite),n.mobLife=l("life "+n.mob.stats.life+" / "+n.mob.stats.lifeMax,[360,250],n.style.mobLife)}function l(a,b,c){_.isUndefined(c)&&(c={font:"bold italic 36px Arial",fill:"#F7EDCA",stroke:"#4a1850",strokeThickness:5});var d=new PIXI.Text(a,c);return d.position.x=b[0],d.position.y=b[1],n.overlayWindow.addChild(d),d}function m(a){if("End"!==a[0].type){var b=$.Deferred();o[a[0].type](a[0],b).then(function(){window.setTimeout(function(){a.shift(),m(a)},1e3)})}else window.setTimeout(function(){n.overlayWindow.renderable=!1,d()},1500)}var n={},o={newRound:function(a,b){return d(),k(),n.position=[200,330],l(a.text,n.position,n.style[a.type]),n.position[1]+=20,b.resolve(),b.promise()},attack:function(a,b){return n.position[0]=20,n.position[1]+=30,l(a.text,n.position,n.style[a.type]),b.resolve(),b.promise()},damagesToPlayer:function(a,b){return n.player.stats.life-=a.opt,n.playerLife.renderable=!1,n.playerLife=l("life "+n.player.stats.life+" / "+n.player.stats.lifeMax,[80,250],n.style.playerLife),n.position[1]+=20,l(a.text,n.position,n.style[a.type]),b.resolve(),b.promise()},damagesToMob:function(a,b){return n.mob.stats.life-=a.opt,n.mobLife.renderable=!1,n.mobLife=l("life "+n.mob.stats.life+" / "+n.mob.stats.lifeMax,[360,250],n.style.mobLife),n.position[1]+=20,l(a.text,n.position,n.style[a.type]),b.resolve(),b.promise()},reward:function(a,b){return n.position[0]=20,n.position[1]+=20,l(a.text,n.position,n.style[a.type]),b.resolve(),b.promise()},weaponReward:function(b,c){d(),n.menuTitle=l(n.fightTitle,[10,10]);var e=a.getAllDatas(),f={font:"bold italic 26px Arial",fill:"#F7EDCA",stroke:"#4a1850",strokeThickness:5};l("You found a new item!",[50,80]),l(b.opt.name,[30,150],f),0===b.opt.enhancement?l("damages: "+b.opt.damages,[80,200],{}):l("damages: "+b.opt.damages+" + "+b.opt.enhancement,[80,200],{});var g=b.opt.hitBonus+b.opt.enhancement;l("hit bonus: "+g,[80,230],{}),l("crit: "+b.opt.critical[0]+"-20  x"+b.opt.critical[1],[80,260],{}),l("Currently equiped: ",[50,350],{}),l(e.weapon.name,[30,390],f),0===e.weapon.enhancement?l("damages: "+e.weapon.damages,[80,440],{}):l("damages: "+e.weapon.damages+" + "+e.weapon.enhancement,[80,440],{}),g=e.weapon.hitBonus+e.weapon.enhancement,l("hit bonus: "+g,[80,470],{}),l("crit: "+e.weapon.critical[0]+"-20  x"+e.weapon.critical[1],[80,500],{});var h=new PIXI.Container,i=new PIXI.Sprite(n.texture.empty);h.addChild(i),h.position.x=420,h.position.y=220,h.buttonMode=!0,h.interactive=!0,l("Use item",[430,220],{}),h.on("click",function(){return a.gainWeapon(b.opt),c.resolve(),c.promise()}),n.overlayWindow.addChild(h);var j=new PIXI.Container,k=new PIXI.Sprite(n.texture.empty);return j.addChild(k),j.position.x=420,j.position.y=260,j.buttonMode=!0,j.interactive=!0,l("Discard",[430,260],{}),j.on("click",function(){return c.resolve(),c.promise()}),n.overlayWindow.addChild(j),c.promise()},armorReward:function(b,c){d(),n.menuTitle=l(n.fightTitle,[10,10]);var e=a.getAllDatas(),f={font:"bold italic 26px Arial",fill:"#F7EDCA",stroke:"#4a1850",strokeThickness:5};l("You found a new item!",[50,80]),l(b.opt.name,[30,150],f);var g=b.opt.defence+b.opt.enhancement;l("armor: "+g,[80,200],{}),l("weight: "+b.opt.weight,[80,230],{}),l("Currently equiped: ",[50,350],{}),l(e.armor.name,[30,390],f),g=e.armor.defence+e.armor.enhancement,l("armor: "+g,[80,440],{}),l("weight: "+e.armor.weight,[80,470],{});var h=new PIXI.Container,i=new PIXI.Sprite(n.texture.empty);h.addChild(i),h.position.x=420,h.position.y=220,h.buttonMode=!0,h.interactive=!0,l("Use item",[430,220],{}),h.on("click",function(){return a.gainArmor(b.opt),c.resolve(),c.promise()}),n.overlayWindow.addChild(h);var j=new PIXI.Container,k=new PIXI.Sprite(n.texture.empty);return j.addChild(k),j.position.x=420,j.position.y=260,j.buttonMode=!0,j.interactive=!0,l("Discard",[430,260],{}),j.on("click",function(){return c.resolve(),c.promise()}),n.overlayWindow.addChild(j),c.promise()},playerDeath:function(a,b){return n.playerSprite.renderable=!1,n.playerLife.renderable=!1,n.position[1]+=20,l(a.text,n.position,n.style[a.type]),b.resolve(),b.promise()},mobDeath:function(a,b){return n.mobSprite.renderable=!1,n.mobLife.renderable=!1,n.position[1]+=20,l(a.text,n.position,n.style[a.type]),b.resolve(),b.promise()},endFight:function(a,b){return n.position[0]=200,n.position[1]+=40,l(a.text,n.position,n.style[a.type]),n.position[1]+=30,b.resolve(),b.promise()}};return{getInterface:function(){return n["interface"]},init:function(){return n["interface"]=new PIXI.Container,n.leftPanel=new PIXI.Graphics,n["interface"].addChild(n.leftPanel),n.texture={button:PIXI.Texture.fromImage("images/button.6a18060b.png"),buttonHover:PIXI.Texture.fromImage("images/buttonhover.5dc1152b.png"),overlayBackground:PIXI.Texture.fromImage("images/menubackground.b4a8eca4.png"),leftPanelBackground:PIXI.Texture.fromImage("images/leftbackground.bd5055fa.png"),"char":PIXI.Texture.fromImage("images/player.1e0c9765.png"),monster:PIXI.Texture.fromImage("images/enemy.e1ddd499.png"),boss:PIXI.Texture.fromImage("images/boss.3c97ab3a.png"),empty:PIXI.Texture.fromImage("images/empty.9442bff8.png")},n.style={newRound:{font:"bold italic 36px Arial",fill:"#F7EDCA",stroke:"#4a1850",strokeThickness:5},endFight:{font:"bold italic 36px Arial",fill:"#F7EDCA",stroke:"#4a1850",strokeThickness:5},reward:{font:"bold 16px Arial"},playerLife:{font:"bold 30px Arial"},playerMana:{font:"bold 30px Arial"},mobLife:{font:"bold 30px Arial"},damagesToMob:{font:"bold 16px Arial"},damagesToPlayer:{font:"bold 16px Arial"},playerDeath:{font:"bold 16px Arial"},mobDeath:{font:"bold 16px Arial"},attack:{font:"bold 16px Arial"}},b(),n["interface"]},openCombatLog:function(a,b){d(),n.overlayWindow.renderable=!0,n.player=a,n.mob=b,n.fightTitle=a.stats.name+" ("+a.stats.level+") -- "+b.stats.name+" ("+b.stats.level+")",k()},renderFight:function(a){m(a)}}}]),angular.module("rpgApp").service("PixiServ",["GameDraw","InterfaceDraw",function(a,b){function c(a,b){f.animating||f["interface"].children[1].renderable?b.reject():(f.animating=!0,a(function(){b.resolve()}))}function d(a,b,d){var e=$.Deferred(),g=function(c){f.intervalCount=0,f.intervalID=window.setInterval(function(){a(),f.intervalCount+=1,f.intervalCount>=d&&(clearInterval(f.intervalID),f.animating=!1,c())},b)};return c(g,e),e.promise()}function e(b){var c=a.moveMap(b);return d(c[0],c[1],c[2])}var f={};return{init:function(c,d){f.renderer=PIXI.autoDetectRenderer(800,600,{view:document.getElementById("game-canvas"),backgroundColor:1087931}),f.stage=new PIXI.Container,f.stage.interactive=!0,f["interface"]=b.init(),f.dungeon=a.init(c,d),f.stage.addChild(f.dungeon),f.stage.addChild(f["interface"])},moveChar:function(b){var c=a.moveChar(b);return d(c[0],c[1],c[2])},render:function(){f.dungeon=a.getGame(),f["interface"]=b.getInterface(),f.renderer.render(f.stage)},mapScroll:function(){var b=[0,0];160===f.dungeon.position.x&&a.getCharPosition()[0]>608?b[0]-=17:-384===f.dungeon.position.x&&a.getCharPosition()[0]<576&&(b[0]+=17),0===f.dungeon.position.y&&a.getCharPosition()[1]>576?b[1]-=16:-512===f.dungeon.position.y&&a.getCharPosition()[1]<544&&(b[1]+=16),(0!==b[0]||0!==b[1])&&e(b)}}}]),angular.module("rpgApp").service("FightEngine",["CharServ","AdversariesServ","InterfaceDraw","ItemsDB",function(a,b,c,d){function e(b){var c=a.getXP(b);if(f(c,"reward"),0===_.random(7)){var e=d.randomRare();a.gainItem(e),f(["You gain a "+e.name+"."],"reward")}if(0===_.random(2)){var g=d.randomPotion();a.gainItem(g),f(["You gain a "+g.name+"."],"reward")}if(0===_.random(2)){var h=d.randomWeapon();f(["You find a new Weapon: "+h.name],"weaponReward",h)}if(0===_.random(2)){var i=d.randomArmor();f(["You find a new Armor: "+i.name],"armorReward",i)}}function f(a,b,c){_.forIn(a,function(a){h.messages.push({text:a,type:b,opt:c})})}function g(a){var b,c;h.roundNumber+=1,f(["Round "+h.roundNumber],"newRound");var d=a.player.attack();if("criticalSuccess"===d.result&&(b=(a.player.rollDamages()+a.player.attribute.strength)*a.player.weapon.critical[1],a.mob.takeDamages(b),f(["You attack: "+d.roll+"   -- CRITICAL HIT!"],"attack"),f(["You hit the enemy and inflict "+b+" damages."],"damagesToMob",b)),"criticalFailure"===d.result&&(b=2,a.player.takeDamages(b),f(["You attack: "+d.roll+"   -- CRITICAL FAILURE!"],"attack"),f(["You hit yourself for "+b+" damages."],"damagesToPlayer",b)),"success"===d.result&&(b=a.player.rollDamages()+a.player.attribute.strength,a.mob.takeDamages(b),f(["You attack: "+d.roll+"    vs enemy defence: "+a.mob.stats.defence+" -- Hit"],"attack"),f(["You hit the enemy and inflict "+b+" damages."],"damagesToMob",b)),"failure"===d.result&&f(["You attack: "+d.roll+"    vs enemy defence: "+a.mob.stats.defence+" -- Miss"],"attack"),a.player.stats.life<1)return f(["You fall to the ground, critically wounded."],"playerDeath"),!1;if(a.mob.stats.life<1)return f(["The enemy dies."],"mobDeath"),!0;var e=a.mob.attack();return"criticalSuccess"===e.result&&(c=(a.mob.rollDamages()+a.mob.attribute.strength)*a.mob.weapon.critical[1],a.player.takeDamages(c),f(["The enemy attacks: "+e.roll+"   -- CRITICAL HIT!"],"attack"),f(["You are hit and receive "+c+" damages."],"damagesToPlayer",c)),"criticalFailure"===e.result&&(c=2,a.mob.takeDamages(c),f(["The enemy attacks: "+e.roll+"   -- CRITICAL FAILURE!"],"attack"),f(["The enemy wounds himself for "+c+" damages."],"damagesToMob",c)),"success"===e.result&&(c=a.mob.rollDamages()+a.mob.attribute.strength,a.player.takeDamages(c),f(["The enemy attacks: "+e.roll+"    vs your defence: "+a.player.stats.defence+" -- Hit"],"attack"),f(["You are hit and receive "+c+" damages."],"damagesToPlayer",c)),"failure"===e.result&&f(["The enemy attacks: "+e.roll+"    vs your defence: "+a.player.stats.defence+" -- Miss"],"attack"),a.player.stats.life<1?(f(["You fall to the ground, critically wounded."],"playerDeath"),!1):a.mob.stats.life<1?(f(["The enemy dies."],"mobDeath"),!0):g(a)}var h={};return{fight:function(){h.roundNumber=0,h.messages=[];var d={player:new Fighter(a.getAllDatas()),mob:new Fighter(b.getStats())};d.player.target=d.mob,d.mob.target=d.player,c.openCombatLog(a.getAllDatas(),b.getStats());var i=g(d);if(i)f(["Victory!"],"endFight"),e(d.mob.stats.xpReward),a.takeDamages(a.getAllDatas().stats.life-d.player.stats.life);else{f(["Defeat!"],"endFight");var j=a.die();f(j,"reward")}f(["END"],"End"),c.renderFight(h.messages)}}}]),angular.module("rpgApp").service("AdversariesServ",["ItemsDB",function(a){function b(a){e.level=_.random(1,a)+_.floor(a/4)}function c(a){e.difficulty=_.random(-1,_.floor(a/3))-1}function d(){e.attribute={strength:_.random(1,3),dexterity:_.random(1,3),endurance:_.random(1,3)},e.stats={name:g[e.difficulty]+" "+f[_.random(f.length-1)],level:e.level,xpReward:e.level*(100+20*e.difficulty)},e.stats.lifeMax=e.stats.level*(6+e.attribute.endurance+_.random(2)*e.difficulty),e.stats.life=e.stats.lifeMax,e.weapon=a.randomBaseWeapon(e.difficulty),e.armor=a.randomBaseArmor(e.difficulty),e.stats.hitBonus=_.floor((e.stats.level+e.attribute.strength+e.weapon.hitBonus+e.weapon.enhancement)*(1-e.armor.weight/100))+_.random(2)*e.difficulty,e.stats.defence=10+e.attribute.dexterity+e.armor.defence+e.armor.enhancement+_.random(2)*e.difficulty}var e={},f=["Alfred","Bob","Caleb","Darius","Eric","Franz","Gustav","Henry","Isidore","Jasper","Kilian","Leopold","Maurice","Nazim","Octave","Peter","Quentin","Rys","Stanis","Ulric","Vassili","Wiliam","Xavier","Yann","Zadig"],g={"-2":"Robber","-1":"Highwayman",0:"Henchman",1:"Mercenary",2:"Guard",3:"Soldier",4:"Squire",5:"Veteran",6:"Captain",7:"Knight",8:"Champion"};return{getStats:function(){return{stats:_.extend({},e.stats),attribute:e.attribute,weapon:e.weapon,armor:e.armor,spells:e.spells,inventory:e.inventory}},defineAdversary:function(a){b(a),c(a),d()},setBoss:function(a){e.level=30,e.difficulty=_.floor(a/5),d(),e.stats.name="Imperator A."}}}]),angular.module("rpgApp").controller("MainCtrl",["$scope","CharServ","MapServ","PixiServ","FightEngine","AdversariesServ",function(a,b,c,d,e,f){function g(){c.load().then(c.reflect).then(b.create).then(function(){d.init(c.getMap(),b.getPosition())}).then(d.mapScroll).then(i).then(h)}function h(){a.frames=0,a.fps=0,window.setInterval(function(){a.$apply(function(){a.fps=a.frames}),a.frames=0},1e3)}function i(){a.frames+=1,d.render(),requestAnimationFrame(i)}function j(a){var g=[b.getPosition()[0]+a[0],b.getPosition()[1]+a[1]];c.isWall(g)||d.moveChar(a).then(function(){b.updatePosition(a),d.mapScroll()}).then(function(){if(18===b.getPosition()[0]&&17===b.getPosition()[1])f.setBoss(b.getAllDatas().stats.level),e.fight();else{var a=0===_.random(5);a?(f.defineAdversary(b.getAllDatas().stats.level),e.fight()):b.lifeRegen()}})}g(),window.addEventListener("keydown",function(a){37===a.keyCode&&j([-1,0]),38===a.keyCode&&j([0,-1]),39===a.keyCode&&j([1,0]),40===a.keyCode&&j([0,1])})}]),angular.module("rpgApp").controller("AboutCtrl",function(){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}),angular.module("rpgApp").controller("FaqCtrl",function(){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}),angular.module("rpgApp").run(["$templateCache",function(a){a.put("views/about.html","<p>This is the about view.</p>"),a.put("views/faq.html","<p>This is the faq view.</p>"),a.put("views/main.html",'<canvas id="game-canvas" width="800" height="600"></canvas> <div id="fps-div">fps: {{ fps }}</div>')}]);